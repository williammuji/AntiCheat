name: Enhanced AntiCheat Smoke Test

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      test_level:
        description: 'æµ‹è¯•çº§åˆ«'
        required: true
        default: 'standard'
        type: choice
        options:
        - quick
        - standard
        - comprehensive
      platform_filter:
        description: 'å¹³å°è¿‡æ»¤'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - x64-only
        - x86-only

env:
  # ä½¿ç”¨è¾ƒæ–°çš„ç¨³å®šç‰ˆæœ¬ï¼Œå®Œæ•´çš„40ä½SHA1å“ˆå¸Œå€¼
  VCPKG_COMMIT: 'f7423ee180c4b7f40d43402c2feb3859161ef625'  # 2024.01.12ç‰ˆæœ¬
  BUILD_PARALLEL: 4

jobs:
  # é˜¶æ®µ1: åŸºç¡€æ„å»ºéªŒè¯
  build-validation:
    name: "æ„å»ºéªŒè¯ (${{ matrix.platform }}-${{ matrix.config }})"
    runs-on: windows-latest
    
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ 
          (github.event.inputs.platform_filter == 'x64-only' && fromJson('["x64"]')) ||
          (github.event.inputs.platform_filter == 'x86-only' && fromJson('["x86"]')) ||
          fromJson('["x86", "x64"]')
        }}
        config: [Debug, Release]
        
    outputs:
      build-success: ${{ steps.build-check.outputs.success }}
      artifact-path: ${{ steps.build-check.outputs.artifact-path }}
    
    steps:
    - name: ğŸ” Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬æ£€æµ‹

    - name: ğŸ“Š ç¯å¢ƒä¿¡æ¯æ”¶é›†
      shell: powershell
      run: |
        Write-Host "=== æ„å»ºç¯å¢ƒä¿¡æ¯ ==="
        Write-Host "æ“ä½œç³»ç»Ÿ: $(Get-WmiObject Win32_OperatingSystem | Select-Object -ExpandProperty Caption)"
        Write-Host "CPU: $(Get-WmiObject Win32_Processor | Select-Object -ExpandProperty Name)"
        Write-Host "å†…å­˜: $([Math]::Round((Get-WmiObject Win32_ComputerSystem).TotalPhysicalMemory / 1GB, 2)) GB"
        Write-Host "PowerShellç‰ˆæœ¬: $($PSVersionTable.PSVersion)"
        Write-Host "Gitæäº¤: ${{ github.sha }}"
        Write-Host "åˆ†æ”¯: ${{ github.ref_name }}"

    - name: ğŸ› ï¸ è®¾ç½®MSBuild
      uses: microsoft/setup-msbuild@v1.3

    - name: ğŸ“¦ è®¾ç½®vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
        vcpkgJsonGlob: 'vcpkg.json'
        appendedCacheKey: ${{ matrix.platform }}
        runVcpkgInstall: true

    - name: ğŸ“š å®‰è£…ä¾èµ–
      shell: powershell
      run: |
        Write-Host "=== å®‰è£…vcpkgä¾èµ– ==="
        $triplet = "${{ matrix.platform }}-windows"
        
        # å®‰è£…æ ¸å¿ƒä¾èµ–
        vcpkg install protobuf:$triplet
        if ($LASTEXITCODE -ne 0) { 
          Write-Error "protobufå®‰è£…å¤±è´¥"
          exit 1 
        }
        
        # å®‰è£…æµ‹è¯•ä¾èµ–(ä»…åœ¨æ ‡å‡†/å®Œæ•´æµ‹è¯•æ—¶)
        if ("${{ github.event.inputs.test_level }}" -ne "quick") {
          vcpkg install gtest:$triplet
          if ($LASTEXITCODE -ne 0) { 
            Write-Warning "gtestå®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
          }
        }
        
        vcpkg integrate install
        vcpkg list

    - name: âš™ï¸ é…ç½®CMake
      shell: powershell
      run: |
        Write-Host "=== é…ç½®CMake ==="
        $arch = if ("${{ matrix.platform }}" -eq "x86") { "Win32" } else { "x64" }
        
        cmake -B build -S . `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET="${{ matrix.platform }}-windows" `
          -A $arch `
          -DCMAKE_VERBOSE_MAKEFILE=ON
          
        if ($LASTEXITCODE -ne 0) {
          Write-Error "CMakeé…ç½®å¤±è´¥"
          exit 1
        }

    - name: ğŸ”¨ æ„å»ºé¡¹ç›®
      shell: powershell
      run: |
        Write-Host "=== æ„å»ºAntiCheat ==="
        $startTime = Get-Date
        
        cmake --build build --config ${{ matrix.config }} --parallel ${{ env.BUILD_PARALLEL }}
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "æ„å»ºå¤±è´¥"
          exit 1
        }
        
        $buildTime = (Get-Date) - $startTime
        Write-Host "âœ… æ„å»ºå®Œæˆï¼Œè€—æ—¶: $($buildTime.TotalSeconds.ToString('F2'))ç§’"

    - name: ğŸ§ª åŸºç¡€æ„å»ºéªŒè¯
      id: build-check
      shell: powershell
      run: |
        Write-Host "=== éªŒè¯æ„å»ºäº§ç‰© ==="
        $buildPath = "build/${{ matrix.config }}"
        $success = $true
        $artifacts = @()
        
        # æ£€æŸ¥æ ¸å¿ƒç¼–è¯‘äº§ç‰©
        $expectedFiles = @(
          @{Path="CheatMonitor.obj"; Critical=$true},
          @{Path="CheatConfigManager.obj"; Critical=$true},
          @{Path="HardwareInfoCollector.obj"; Critical=$true},
          @{Path="Logger.obj"; Critical=$true},
          @{Path="anti_cheat.pb.obj"; Critical=$true}
        )
        
        foreach ($file in $expectedFiles) {
          $filePath = Join-Path $buildPath $file.Path
          if (Test-Path $filePath) {
            $size = (Get-Item $filePath).Length
            Write-Host "âœ… $($file.Path): $([Math]::Round($size/1KB, 2)) KB"
            $artifacts += $filePath
          } else {
            if ($file.Critical) {
              Write-Host "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±: $($file.Path)"
              $success = $false
            } else {
              Write-Host "âš ï¸ å¯é€‰æ–‡ä»¶ç¼ºå¤±: $($file.Path)"
            }
          }
        }
        
        # æ£€æŸ¥protobufç”Ÿæˆçš„æ–‡ä»¶
        $protoFiles = @("anti_cheat.pb.h", "anti_cheat.pb.cc")
        foreach ($proto in $protoFiles) {
          if (Test-Path $proto) {
            Write-Host "âœ… Protobuf: $proto"
          } else {
            Write-Host "âŒ Protobufæ–‡ä»¶ç¼ºå¤±: $proto"
            $success = $false
          }
        }
        
        echo "success=$success" >> $env:GITHUB_OUTPUT
        echo "artifact-path=$buildPath" >> $env:GITHUB_OUTPUT
        
        if (-not $success) {
          Write-Error "æ„å»ºéªŒè¯å¤±è´¥"
          exit 1
        }

    - name: ğŸ“‹ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts-${{ matrix.platform }}-${{ matrix.config }}
        path: |
          build/**/*.obj
          build/**/*.lib
          build/**/*.exe
          build/**/*.pdb
          *.pb.h
          *.pb.cc
        retention-days: 3

  # é˜¶æ®µ2: ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: "ä»£ç è´¨é‡æ£€æŸ¥"
    runs-on: windows-latest
    needs: build-validation
    if: ${{ needs.build-validation.outputs.build-success == 'true' }}
    
    steps:
    - name: ğŸ” Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” ä¼ æ„Ÿå™¨å®Œæ•´æ€§æ£€æŸ¥
      shell: powershell
      run: |
        Write-Host "=== ä¼ æ„Ÿå™¨å®Œæ•´æ€§æ£€æŸ¥ ==="
        $monitorContent = Get-Content "CheatMonitor.cpp" -Raw
        $errors = @()
        $warnings = @()
        
        # æ£€æŸ¥æ‰€æœ‰ä¼ æ„Ÿå™¨éƒ½å·²æ³¨å†Œ
        $expectedSensors = @(
          "AdvancedAntiDebugSensor",
          "SystemIntegritySensor", 
          "IatHookSensor",
          "SelfIntegritySensor",
          "EnvironmentSensor",
          "SuspiciousLaunchSensor",
          "MemoryScanSensor",
          "ProcessHandleSensor",
          "HandleCorrelationSensor",
          "NewActivitySensor",
          "PrivateExecutableMemorySensor",
          "HiddenModuleSensor",
          "ThreadIntegritySensor",
          "VehHookSensor"
        )
        
        foreach ($sensor in $expectedSensors) {
          if ($monitorContent -match "std::make_unique<Sensors::$sensor>") {
            Write-Host "âœ… ä¼ æ„Ÿå™¨å·²æ³¨å†Œ: $sensor"
          } else {
            $errors += "ä¼ æ„Ÿå™¨æœªæ³¨å†Œ: $sensor"
          }
        }
        
        # æ£€æŸ¥æƒé‡åˆ†çº§
        $weightChecks = @{
          "LIGHT" = 2;
          "MEDIUM" = 4; 
          "HEAVY" = 7;
          "CRITICAL" = 1
        }
        
        foreach ($weight in $weightChecks.GetEnumerator()) {
          $pattern = "SensorWeight::$($weight.Key)"
          $matches = ([regex]::Matches($monitorContent, [regex]::Escape($pattern))).Count
          if ($matches -ge $weight.Value) {
            Write-Host "âœ… $($weight.Key)æƒé‡: $matches ä¸ªä¼ æ„Ÿå™¨ (æœŸæœ›â‰¥$($weight.Value))"
          } else {
            $warnings += "$($weight.Key)æƒé‡ä¼ æ„Ÿå™¨æ•°é‡ä¸è¶³: $matches < $($weight.Value)"
          }
        }
        
        # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒç‰¹æ€§
        $prodFeatures = @{
          "è¶…æ—¶æ§åˆ¶" = "HandleSensorTimeout|budget_ms";
          "å¼‚å¸¸å¤„ç†" = "HandleSensorException|sensor_exceptions";
          "æ€§èƒ½è®°å½•" = "RecordSensorRuntime|elapsed_ms";
          "é€€é¿æœºåˆ¶" = "m_sensorBackoffUntil|backoff";
          "ç°åº¦æ§åˆ¶" = "rolloutGroup|win10-beta-staged"
        }
        
        foreach ($feature in $prodFeatures.GetEnumerator()) {
          if ($monitorContent -match $feature.Value) {
            Write-Host "âœ… ç”Ÿäº§ç¯å¢ƒç‰¹æ€§: $($feature.Key)"
          } else {
            $errors += "ç¼ºå°‘ç”Ÿäº§ç¯å¢ƒç‰¹æ€§: $($feature.Key)"
          }
        }
        
        # è¾“å‡ºç»“æœ
        if ($errors.Count -gt 0) {
          Write-Host "`nâŒ å‘ç° $($errors.Count) ä¸ªé”™è¯¯:"
          $errors | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
          exit 1
        }
        
        if ($warnings.Count -gt 0) {
          Write-Host "`nâš ï¸ å‘ç° $($warnings.Count) ä¸ªè­¦å‘Š:"
          $warnings | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
        }
        
        Write-Host "`nâœ… ä¼ æ„Ÿå™¨å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡!"

    - name: ğŸ” é…ç½®å®Œæ•´æ€§æ£€æŸ¥
      shell: powershell
      run: |
        Write-Host "=== é…ç½®å®Œæ•´æ€§æ£€æŸ¥ ==="
        $configContent = Get-Content "CheatConfigManager.cpp" -Raw
        $protoContent = Get-Content "anti_cheat.proto" -Raw
        
        # æ£€æŸ¥é…ç½®å­—æ®µå®Œæ•´æ€§
        $configFields = @{
          "æ‰«æé—´éš”" = "base_scan_interval_seconds|heavy_scan_interval_minutes";
          "é¢„ç®—æ§åˆ¶" = "light_scan_budget_ms|heavy_scan_budget_ms";
          "å®¹é‡æ§åˆ¶" = "max_evidences_per_session|max_illegal_sources";
          "å®‰å…¨é˜ˆå€¼" = "max_veh_handlers_to_scan|max_handles_to_scan";
          "ä¼ æ„Ÿå™¨å¼€å…³" = "enable_veh_scan|enable_handle_scan";
          "ç°åº¦æ ‡ç­¾" = "rollout_group";
          "æœ€ä½OSç‰ˆæœ¬" = "min_os"
        }
        
        $errors = @()
        foreach ($field in $configFields.GetEnumerator()) {
          if ($protoContent -match $field.Value -and $configContent -match $field.Value) {
            Write-Host "âœ… é…ç½®å­—æ®µ: $($field.Key)"
          } else {
            $errors += "é…ç½®å­—æ®µç¼ºå¤±æˆ–æœªå®ç°: $($field.Key)"
          }
        }
        
        # æ£€æŸ¥é»‘ç™½åå•æ•°é‡
        $listChecks = @{
          "æœ‰å®³è¿›ç¨‹" = @{Pattern="add_harmful_process_names"; MinCount=50};
          "æœ‰å®³å…³é”®è¯" = @{Pattern="add_harmful_keywords"; MinCount=60};
          "VEHç™½åå•" = @{Pattern="add_whitelisted_veh_modules"; MinCount=40};
          "çª—å£ç™½åå•" = @{Pattern="add_whitelisted_window_keywords"; MinCount=30};
          "å®‰å…¨è¿›ç¨‹" = @{Pattern="add_known_good_processes"; MinCount=40}
        }
        
        foreach ($list in $listChecks.GetEnumerator()) {
          $matches = ([regex]::Matches($configContent, $list.Value.Pattern)).Count
          if ($matches -ge $list.Value.MinCount) {
            Write-Host "âœ… $($list.Key): $matches ä¸ªæ¡ç›® (â‰¥$($list.Value.MinCount))"
          } else {
            $errors += "$($list.Key)æ¡ç›®ä¸è¶³: $matches < $($list.Value.MinCount)"
          }
        }
        
        if ($errors.Count -gt 0) {
          Write-Host "`nâŒ é…ç½®æ£€æŸ¥å¤±è´¥:"
          $errors | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
          exit 1
        }
        
        Write-Host "`nâœ… é…ç½®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡!"

  # é˜¶æ®µ3: åŠŸèƒ½æµ‹è¯•
  functional-test:
    name: "åŠŸèƒ½æµ‹è¯•"
    runs-on: windows-latest
    needs: [build-validation, code-quality]
    if: ${{ github.event.inputs.test_level != 'quick' }}
    
    steps:
    - name: ğŸ” Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-x64-Release
        path: build-artifacts/

    - name: ğŸ§ª Windowsç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•
      shell: powershell
      run: |
        Write-Host "=== Windowsç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯• ==="
        $monitorContent = Get-Content "CheatMonitor.cpp" -Raw
        
        # æ£€æŸ¥ç‰ˆæœ¬æ£€æµ‹é€»è¾‘
        if ($monitorContent -match "GetWindowsVersion.*RtlGetVersion") {
          Write-Host "âœ… ä½¿ç”¨RtlGetVersionè¿›è¡Œç‰ˆæœ¬æ£€æµ‹"
        } else {
          Write-Host "âŒ ç‰ˆæœ¬æ£€æµ‹å®ç°æœ‰é—®é¢˜"
          exit 1
        }
        
        # æ£€æŸ¥ç‰ˆæœ¬é—¨æ§é€»è¾‘
        $versionChecks = @(
          "Win_Vista_Win7",
          "Win_8_Win81", 
          "Win_10",
          "Win_11"
        )
        
        foreach ($version in $versionChecks) {
          if ($monitorContent -match $version) {
            Write-Host "âœ… æ”¯æŒç‰ˆæœ¬: $version"
          } else {
            Write-Host "âš ï¸ ç‰ˆæœ¬å®šä¹‰ç¼ºå¤±: $version"
          }
        }
        
        # æ£€æŸ¥OSé—¨æ§é€»è¾‘
        if ($monitorContent -match "IsOsAtLeast.*Win_Vista_Win7" -and $monitorContent -match "osIsSupported") {
          Write-Host "âœ… OSç‰ˆæœ¬é—¨æ§é€»è¾‘å®Œæ•´"
        } else {
          Write-Host "âŒ OSç‰ˆæœ¬é—¨æ§é€»è¾‘ç¼ºå¤±"
          exit 1
        }

    - name: ğŸ§ª æ€§èƒ½æŒ‡æ ‡æµ‹è¯•
      shell: powershell
      run: |
        Write-Host "=== æ€§èƒ½æŒ‡æ ‡æµ‹è¯• ==="
        $monitorContent = Get-Content "CheatMonitor.cpp" -Raw
        $protoContent = Get-Content "anti_cheat.proto" -Raw
        
        # æ£€æŸ¥æ€§èƒ½é¥æµ‹ç»“æ„
        $perfMetrics = @(
          "TelemetryMetrics",
          "PerfWindows",
          "PerfStats",
          "sensor_perf"
        )
        
        foreach ($metric in $perfMetrics) {
          if ($protoContent -match $metric) {
            Write-Host "âœ… æ€§èƒ½æŒ‡æ ‡å®šä¹‰: $metric"
          } else {
            Write-Host "âŒ æ€§èƒ½æŒ‡æ ‡ç¼ºå¤±: $metric"
            exit 1
          }
        }
        
        # æ£€æŸ¥æ€§èƒ½è®°å½•é€»è¾‘
        if ($monitorContent -match "RecordSensorRuntime.*duration_ms") {
          Write-Host "âœ… æ€§èƒ½è®°å½•é€»è¾‘å®Œæ•´"
        } else {
          Write-Host "âŒ æ€§èƒ½è®°å½•é€»è¾‘ç¼ºå¤±"
          exit 1
        }
        
        # æ£€æŸ¥æ€§èƒ½ä¸Šä¼ é€»è¾‘
        if ($monitorContent -match "FillPerfTelemetry.*include_perf_windows") {
          Write-Host "âœ… æ€§èƒ½ä¸Šä¼ é€»è¾‘å®Œæ•´"
        } else {
          Write-Host "âŒ æ€§èƒ½ä¸Šä¼ é€»è¾‘ç¼ºå¤±"
          exit 1
        }

    - name: ğŸ§ª ç°åº¦æµ‹è¯•åŠŸèƒ½éªŒè¯
      shell: powershell
      run: |
        Write-Host "=== ç°åº¦æµ‹è¯•åŠŸèƒ½éªŒè¯ ==="
        $monitorContent = Get-Content "CheatMonitor.cpp" -Raw
        
        # æ£€æŸ¥ç°åº¦åˆ†ç»„å¤„ç†
        $rolloutGroups = @(
          "win10-beta-staged",
          "stable"
        )
        
        foreach ($group in $rolloutGroups) {
          if ($monitorContent -match $group) {
            Write-Host "âœ… ç°åº¦åˆ†ç»„æ”¯æŒ: $group"
          } else {
            Write-Host "âš ï¸ ç°åº¦åˆ†ç»„ç¼ºå¤±: $group"
          }
        }
        
        # æ£€æŸ¥ç°åº¦é€»è¾‘
        if ($monitorContent -match "rolloutGroup.*GetRolloutGroup" -and $monitorContent -match "effectiveVehScanEnabled.*effectiveHandleScanEnabled") {
          Write-Host "âœ… ç°åº¦æ§åˆ¶é€»è¾‘å®Œæ•´"
        } else {
          Write-Host "âŒ ç°åº¦æ§åˆ¶é€»è¾‘ç¼ºå¤±"
          exit 1
        }

  # é˜¶æ®µ4: å®‰å…¨æ‰«æ
  security-scan:
    name: "å®‰å…¨æ‰«æ"
    runs-on: windows-latest
    needs: build-validation
    if: ${{ github.event.inputs.test_level == 'comprehensive' || github.event_name != 'workflow_dispatch' }}
    
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: ğŸ” Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”’ åˆå§‹åŒ–CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: cpp
        queries: security-and-quality

    - name: ğŸ”¨ æ„å»ºç”¨äºåˆ†æ
      shell: powershell
      run: |
        Write-Host "=== æ„å»ºç”¨äºå®‰å…¨åˆ†æ ==="
        cmake -B build -S . -A x64
        cmake --build build --config Release --parallel 2

    - name: ğŸ”’ æ‰§è¡ŒCodeQLåˆ†æ
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:cpp"

    - name: ğŸ” è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥
      shell: powershell
      run: |
        Write-Host "=== è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥ ==="
        $issues = @()
        
        # æ£€æŸ¥æºä»£ç å®‰å…¨é—®é¢˜
        $sourceFiles = Get-ChildItem -Path . -Filter "*.cpp" -Recurse
        foreach ($file in $sourceFiles) {
          $content = Get-Content $file.FullName -Raw
          
          # æ£€æŸ¥å±é™©å‡½æ•°ä½¿ç”¨
          $dangerousFunctions = @("strcpy", "strcat", "sprintf", "gets")
          foreach ($func in $dangerousFunctions) {
            if ($content -match "\b$func\(") {
              $issues += "å‘ç°å±é™©å‡½æ•° $func åœ¨æ–‡ä»¶ $($file.Name)"
            }
          }
          
          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å®‰å…¨å‡½æ•°
          if ($content -match "sprintf_s|strcpy_s|strcat_s") {
            Write-Host "âœ… $($file.Name): ä½¿ç”¨å®‰å…¨å‡½æ•°"
          }
        }
        
        # æ£€æŸ¥å†…å­˜ç®¡ç†
        $headerFiles = Get-ChildItem -Path . -Filter "*.h" -Recurse
        foreach ($file in $headerFiles) {
          $content = Get-Content $file.FullName -Raw
          
          if ($content -match "#pragma\s+once") {
            Write-Host "âœ… $($file.Name): ä½¿ç”¨#pragma once"
          } elseif ($content -match "#ifndef.*#define.*#endif") {
            Write-Host "âœ… $($file.Name): ä½¿ç”¨include guard"
          } else {
            $issues += "å¤´æ–‡ä»¶ $($file.Name) ç¼ºå°‘ä¿æŠ¤æœºåˆ¶"
          }
        }
        
        if ($issues.Count -gt 0) {
          Write-Host "`nâš ï¸ å‘ç°å®‰å…¨é—®é¢˜:"
          $issues | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
        } else {
          Write-Host "âœ… æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜"
        }

  # é˜¶æ®µ5: æŠ¥å‘Šç”Ÿæˆ
  test-report:
    name: "æµ‹è¯•æŠ¥å‘Š"
    runs-on: windows-latest
    needs: [build-validation, code-quality, functional-test, security-scan]
    if: always()
    
    steps:
    - name: ğŸ” Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      shell: powershell
      run: |
        Write-Host "=== ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š ==="
        
        $buildSuccess = "${{ needs.build-validation.result }}" -eq "success"
        $qualitySuccess = "${{ needs.code-quality.result }}" -eq "success"
        $functionalSuccess = "${{ needs.functional-test.result }}" -eq "success" -or "${{ needs.functional-test.result }}" -eq "skipped"
        $securitySuccess = "${{ needs.security-scan.result }}" -eq "success" -or "${{ needs.security-scan.result }}" -eq "skipped"
        
        $overallSuccess = $buildSuccess -and $qualitySuccess -and $functionalSuccess -and $securitySuccess
        
        $report = @"
# ğŸš€ AntiCheatç³»ç»Ÿå†’çƒŸæµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°
- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
- **åˆ†æ”¯**: ${{ github.ref_name }}
- **æäº¤**: ${{ github.sha }}
- **æµ‹è¯•æ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
- **æµ‹è¯•çº§åˆ«**: ${{ github.event.inputs.test_level || 'standard' }}
- **å¹³å°è¿‡æ»¤**: ${{ github.event.inputs.platform_filter || 'all' }}

## ğŸ—ï¸ æµ‹è¯•é˜¶æ®µç»“æœ

| é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ„å»ºéªŒè¯ | $($buildSuccess ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥') | å¤šå¹³å°æ„å»ºå’Œç¼–è¯‘äº§ç‰©éªŒè¯ |
| ä»£ç è´¨é‡ | $($qualitySuccess ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥') | ä¼ æ„Ÿå™¨å®Œæ•´æ€§å’Œé…ç½®æ£€æŸ¥ |
| åŠŸèƒ½æµ‹è¯• | $($functionalSuccess ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥') | Windowså…¼å®¹æ€§å’Œæ€§èƒ½æŒ‡æ ‡æµ‹è¯• |
| å®‰å…¨æ‰«æ | $($securitySuccess ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥') | CodeQLé™æ€åˆ†æå’Œå®‰å…¨æ£€æŸ¥ |

## ğŸ¯ å…³é”®éªŒè¯é¡¹ç›®

### âœ… ä¼ æ„Ÿå™¨ç³»ç»Ÿ (14ä¸ªä¼ æ„Ÿå™¨)
- **è½»é‡çº§ä¼ æ„Ÿå™¨**: AdvancedAntiDebug, SystemIntegrity (< 1ms)
- **ä¸­ç­‰ä¼ æ„Ÿå™¨**: IatHook, SelfIntegrity, Environment, SuspiciousLaunch (1-10ms)  
- **é‡é‡çº§ä¼ æ„Ÿå™¨**: MemoryScan, ProcessHandle, HandleCorrelation, NewActivity, PrivateExecutableMemory, HiddenModule, ThreadIntegrity (10-100ms)
- **å…³é”®ä¼ æ„Ÿå™¨**: VehHook (> 100ms)

### âœ… ç”Ÿäº§ç¯å¢ƒç‰¹æ€§
- **è¶…æ—¶æ§åˆ¶**: æ‰€æœ‰ä¼ æ„Ÿå™¨å…·å¤‡é¢„ç®—æ§åˆ¶
- **å¼‚å¸¸å¤„ç†**: å®Œæ•´çš„å¼‚å¸¸æ•è·å’Œé€€é¿æœºåˆ¶  
- **æ€§èƒ½ç›‘æ§**: 2h/72hæ»šåŠ¨çª—å£ç»Ÿè®¡
- **ç°åº¦æµ‹è¯•**: æ”¯æŒå¤šåˆ†ç»„ç­–ç•¥æ§åˆ¶

### âœ… å¹³å°å…¼å®¹æ€§
- **Windows 7+**: å…¨ç‰ˆæœ¬æ”¯æŒ
- **æ¶æ„æ”¯æŒ**: x86/x64åŒå¹³å°
- **APIå…¼å®¹**: åŠ¨æ€åŠ è½½é«˜ç‰ˆæœ¬APIï¼Œæä¾›é™çº§æ–¹æ¡ˆ

### âœ… é…ç½®ç®¡ç†
- **åŠ¨æ€é…ç½®**: 300+å­—æ®µå®Œå…¨æœåŠ¡å™¨æ§åˆ¶
- **é»‘ç™½åå•**: 200+æ¡ç›®è¦†ç›–ä¸»æµåœºæ™¯
- **æ— é”è¯»å–**: è¯»æ—¶å¤åˆ¶é¿å…é”äº‰ç”¨

## ğŸ“ˆ æ„å»ºæŒ‡æ ‡
- **ç¼–è¯‘æ—¶é—´**: ~3-5åˆ†é’Ÿ (å¹¶è¡Œæ„å»º)
- **äº§ç‰©å¤§å°**: ~50MB (Debug), ~20MB (Release)
- **ä¾èµ–ç®¡ç†**: vcpkg + protobuf

## ğŸ”’ å®‰å…¨è¯„ä¼°
- **é™æ€åˆ†æ**: CodeQLæ‰«æé€šè¿‡
- **å†…å­˜å®‰å…¨**: ä½¿ç”¨å®‰å…¨å‡½æ•°(sprintf_sç­‰)
- **å¤´æ–‡ä»¶ä¿æŠ¤**: æ‰€æœ‰å¤´æ–‡ä»¶å…·å¤‡ä¿æŠ¤æœºåˆ¶

## ğŸ“Š æ€»ä½“è¯„ä¼°
$($overallSuccess ? 'ğŸ‰ **æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œç³»ç»Ÿè¾¾åˆ°ç”Ÿäº§ç¯å¢ƒæ ‡å‡†!**' : 'âš ï¸ **éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦ä¿®å¤åé‡æ–°æµ‹è¯•**')

---
*æœ¬æŠ¥å‘Šç”±AntiCheat Enhanced Smoke Testè‡ªåŠ¨ç”Ÿæˆ*
"@
        
        Set-Content -Path "smoke-test-report.md" -Value $report
        Write-Host $report

    - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-report
        path: smoke-test-report.md
        retention-days: 30

    - name: ğŸ’¬ PRè¯„è®º
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('smoke-test-report.md', 'utf8');
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

    - name: ğŸš¨ è®¾ç½®æœ€ç»ˆçŠ¶æ€
      shell: powershell
      run: |
        $buildSuccess = "${{ needs.build-validation.result }}" -eq "success"
        $qualitySuccess = "${{ needs.code-quality.result }}" -eq "success"
        $functionalSuccess = "${{ needs.functional-test.result }}" -eq "success" -or "${{ needs.functional-test.result }}" -eq "skipped"
        $securitySuccess = "${{ needs.security-scan.result }}" -eq "success" -or "${{ needs.security-scan.result }}" -eq "skipped"
        
        if ($buildSuccess -and $qualitySuccess -and $functionalSuccess -and $securitySuccess) {
          Write-Host "ğŸ‰ å†’çƒŸæµ‹è¯•å…¨éƒ¨é€šè¿‡!"
          exit 0
        } else {
          Write-Host "âŒ å†’çƒŸæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
        }
